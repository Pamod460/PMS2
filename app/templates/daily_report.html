{% extends "base.html" %}

{% block title %}Daily Report{% endblock %}

{% block content %}
<div id="report-container">
    <h2 class="text-center">Daily Report</h2>
    <table class="table table-striped" style="width: 500px; height: max-content;">
        <thead>
            <tr>
                <th>Patient Name</th>
                <th>Charges</th>
            </tr>
        </thead>
        <tbody id="report-body">
            <!-- Records will be injected here by AJAX -->
        </tbody>
    </table>
</div>
<div class="text-center">
    <a class="btn btn-primary" id="download-report">Download Report</a>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script>

    $(document).ready(function () {
        $('#download-report').click(

            function () {
                var element = document.getElementById('report-container');
                var date=new Date();
                date = date.getFullYear()+"-"+date.getMonth()+"-"+date.getDay();
                var opt = {
                    margin: 1,
                    filename: 'daily_report_'+date+'.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                // New Promise-based usage:
                html2pdf().from(element).set(opt).save();
            });
        // Function to load the daily report data
        function loadDailyReport() {
            $.ajax({
                url: "{{ url_for('get_daily_report') }}",
                method: "GET",
                dataType: "json",
                success: function (response) {
                    console.log(response);
                    var reportBody = $('#report-body');
                    reportBody.empty(); // Clear previous records

                    if (response.records && response.records.length > 0) {
                        response.records.forEach(function (record) {
                            var row = $('<tr></tr>');
                            row.append('<td>' + record[0] + '</td>');
                            row.append('<td>' + record[1] + '</td>');
                            reportBody.append(row);

                        });
                        var row2 = $('<tr></tr>');
                        row2.append('<td>Total</td>');
                        row2.append('<td>' + response.total[0] + '</td>');
                        reportBody.append(row2);

                    } else {
                        reportBody.append('<tr><td colspan="8">No records found for today.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error(error);
                    $('#report-body').empty().append('<tr><td colspan="8">An error occurred while loading the report. Please try again.</td></tr>');
                }
            });
        }

        // Load the daily report on page load
        loadDailyReport();
    });
</script>
{% endblock %}